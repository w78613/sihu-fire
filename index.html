<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å››æ¹–åˆ†éšŠé å®šè¡¨ç³»çµ± - é›²ç«¯å³æ™‚ç‰ˆ</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.16.0/firebase-database-compat.js"></script>

    <script>
        // Firebase é…ç½® (å·²å¡«å…¥ä½ æä¾›çš„è³‡è¨Š)
        const firebaseConfig = {
            apiKey: "AIzaSyDKwKV9ymvPaXP8cG76vnjISrl1dtfXBrs",
            authDomain: "sihu-fire-duty.firebaseapp.com",
            databaseURL: "https://sihu-fire-duty-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "sihu-fire-duty",
            storageBucket: "sihu-fire-duty.firebasestorage.app",
            messagingSenderId: "196116965207",
            appId: "1:196116965207:web:9ca18084c3b69f0c550012",
            measurementId: "G-51TZMYZ840"
        };

        // åˆå§‹åŒ– Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
    </script>

    <style>
        :root {
            --header-blue: #e7f1ff;
            --sunday-red: #ffe3e3;
            --saturday-orange: #fff5e6;
            --holiday-green: #d4edda;
            --exchange-orange: #ffeeba;
            --monthly-blue: #bee5eb;
            --official-red: #f8d7da;
        }
        body { font-family: "Microsoft JhengHei", sans-serif; margin: 10px; background: #f4f7f6; }
        .title-area { text-align: center; margin-bottom: 15px; }
        #displayDate { font-size: 28px; font-weight: bold; color: #333; }
        
        .controls { 
            display: flex; gap: 15px; align-items: center; justify-content: center; flex-wrap: wrap;
            margin-bottom: 15px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        
        #saveStatus { position: absolute; top: 5px; right: 15px; font-size: 11px; color: #28a745; font-weight: bold; }

        table { border-collapse: collapse; width: 100%; background: white; table-layout: fixed; border: 2px solid #333; }
        th, td { border: 1px solid #666; text-align: center; padding: 2px; font-size: 13px; height: 38px; position: relative; }
        
        .col-date, .col-day { width: 40px; font-weight: bold; }
        .col-staff { width: auto; min-width: 45px; }
        .col-note { width: 110px; }
        .col-stat-wide { width: 70px; font-weight: bold; background: #f9f9f9; font-size: 11px; }
        
        .hide-col { display: none !important; }

        .header-row { background: var(--header-blue); }
        .sunday { background: var(--sunday-red) !important; color: #d00; }
        .saturday { background: var(--saturday-orange) !important; color: #e67e22; }
        
        .status-holiday { background-color: var(--holiday-green) !important; } 
        .status-exchange { background-color: var(--exchange-orange) !important; } 
        .status-monthly { background-color: var(--monthly-blue) !important; } 
        .status-official { background-color: var(--official-red) !important; } 
        .warning-red { background-color: #ff4d4d !important; color: white; }

        .editable-content { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; outline: none; min-height: 35px; }
        .editable-content:focus { background: #fffde7; }

        .quick-menu {
            display: none; position: absolute; bottom: 105%; left: 50%; transform: translateX(-50%);
            background: white; border: 1px solid #333; z-index: 100; box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border-radius: 4px; padding: 2px; width: 90px;
        }
        .cell:focus-within .quick-menu { display: flex; flex-direction: column; }
        .quick-btn { padding: 6px; font-size: 12px; cursor: pointer; border: none; background: white; text-align: center; border-bottom: 1px solid #eee; }

        #staffModal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border: 2px solid #333; padding: 20px; z-index: 1000; border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        @media print {
            .controls, #staffModal, .quick-menu, #saveStatus { display: none !important; }
            @page { size: A3 landscape; margin: 0.5cm; }
        }

        .btn { padding: 8px 14px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; font-size: 13px; background: #6c757d; color: white; }
        .order-input { width: 180px; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 15px; }
    </style>
</head>
<body onpaste="handleGlobalPaste(event)">

<div class="title-area">
    <div id="displayDate">é›²æ—ç¸£æ¶ˆé˜²å±€ç¬¬ä¸‰å¤§éšŠå››æ¹–åˆ†éšŠ <span id="yearVal">2026</span>å¹´<span id="monthVal">2</span>æœˆé å®šè¡¨</div>
</div>

<div class="controls">
    <div id="saveStatus">â— å·²åŒæ­¥é›²ç«¯</div>
    <input type="month" id="monthPicker" value="2026-02" onchange="initTable()">
    <button class="btn" onclick="toggleStaffModal()">ğŸ‘¥ äººå“¡åå–®</button>
    <button class="btn" onclick="toggleStats()" style="background:#17a2b8;">ğŸ‘ï¸ éš±è—/é¡¯ç¤ºè¼”åŠ©åˆ—</button>
    
    <div style="border-left: 2px solid #eee; padding-left: 12px; display: flex; gap: 8px; align-items: center;">
        <span>Aç­å¡«å‡é †åºï¼š</span><input type="text" id="seqA" class="order-input" placeholder="æ•¸å­—é †åº" oninput="saveSettings()">
        <span>Bç­å¡«å‡é †åºï¼š</span><input type="text" id="seqB" class="order-input" placeholder="æ•¸å­—é †åº" oninput="saveSettings()">
    </div>

    <button class="btn" onclick="window.print()" style="background:#28a745;">ğŸ–¨ï¸ A3 åˆ—å°</button>
    <button class="btn" onclick="clearData()" style="background:#dc3545;">ğŸ—‘ï¸ æ¸…ç©º</button>
</div>

<table id="dutyTable"></table>

<div id="staffModal">
    <h3 style="margin-top:0">äººå“¡åå–®ç·¨è¼¯ (åŒæ­¥é›²ç«¯)</h3>
    <div id="staffInputs" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
    <hr>
    <div style="display: flex; justify-content: space-between;">
        <button class="btn" onclick="saveStaffNames()" style="background:#007bff;">ç¢ºèªæ›´æ–°</button>
        <button class="btn" onclick="toggleStaffModal()" style="background:#bbb;">å–æ¶ˆ</button>
    </div>
</div>

<script>
let hideStats = true; 
let staffNames = ["ç‹æŸæ£®","å³ç§‘èˆˆ","ç‹æŒ¯å·","è”¡éŠ˜æ±¶","å‘‚æ­¦é™µ","æ›¾å¿—ä»","è³´é•·ç’Ÿ","è”¡é§¿é¨°","ç‹ç§‰ç‘‹","å³è±æ¨¹","è¨±å®¶ç‘‹","é™³å¥é›„","æ¢ç›Šç‘","æ—æ­¦è³¢","","","",""];
const quickOptions = ["ä¼‘å‡1", "ä¼‘å‡2", "æ›ä¼‘1", "æ›ä¼‘2", "æœˆè£œ", "å…¬å‡A1"];

// é¡¯ç¤ºå„²å­˜ç‹€æ…‹
function showSaved(text = "â— å·²åŒæ­¥é›²ç«¯", color = "#28a745") {
    const s = document.getElementById('saveStatus');
    s.innerText = text;
    s.style.color = color;
}

// å„²å­˜è¨­å®š (A/Bç­é †åº) åˆ°é›²ç«¯
function saveSettings() {
    const [year, month] = document.getElementById('monthPicker').value.split('-');
    const settings = {
        seqA: document.getElementById('seqA').value,
        seqB: document.getElementById('seqB').value
    };
    db.ref(`duty_system/${year}_${month}/settings`).set(settings);
    showSaved("â— å„²å­˜ä¸­...", "#ff9800");
}

function toggleStaffModal() {
    const modal = document.getElementById('staffModal');
    if (modal.style.display === 'block') {
        modal.style.display = 'none';
    } else {
        const container = document.getElementById('staffInputs');
        container.innerHTML = staffNames.map((name, i) => `<div>${i+1}: <input type="text" value="${name}" id="staffInput${i}" style="width:80px"></div>`).join('');
        modal.style.display = 'block';
    }
}

// å„²å­˜åå–®åˆ°é›²ç«¯
function saveStaffNames() {
    const newNames = [];
    for (let i = 0; i < 18; i++) { newNames.push(document.getElementById(`staffInput${i}`).value.trim()); }
    db.ref(`duty_system/global/staffNames`).set(newNames);
    toggleStaffModal();
}

function toggleStats() { hideStats = !hideStats; initTable(); }

// åˆå§‹åŒ–èˆ‡å³æ™‚ç›£è½é›²ç«¯è³‡æ–™
function initTable() {
    const [year, month] = document.getElementById('monthPicker').value.split('-');
    document.getElementById('yearVal').innerText = year;
    document.getElementById('monthVal').innerText = parseInt(month);
    
    // 1. å…ˆç›£è½äººå“¡åå–® (å…¨åŸŸ)
    db.ref(`duty_system/global/staffNames`).on('value', (snapshot) => {
        if (snapshot.val()) { staffNames = snapshot.val(); }
        
        // 2. ç›£è½ç•¶æœˆè³‡æ–™
        db.ref(`duty_system/${year}_${month}`).on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const savedData = data.content || {};
            const settings = data.settings || { seqA: "", seqB: "" };

            document.getElementById('seqA').value = settings.seqA;
            document.getElementById('seqB').value = settings.seqB;

            renderTable(year, month, savedData);
            showSaved();
        });
    });
}

function renderTable(year, month, savedData) {
    const daysInMonth = new Date(year, month, 0).getDate();
    const table = document.getElementById('dutyTable');
    
    let html = `<thead><tr class="header-row">
            <th class="col-date">æ—¥</th><th class="col-day">ä¸€</th>
            ${staffNames.map((name, i) => name ? `<th class="col-staff">${i+1}<br>${name}</th>` : '').join('')}
            <th class="col-note">å‚™è¨»</th>
            <th class="col-stat-wide">å¯å¡«å‡</th>
            <th class="col-stat-wide ${hideStats?'hide-col':''}">é è¨ˆæ ¼æ•¸</th>
            <th class="col-stat-wide ${hideStats?'hide-col':''}">é æ‰£å¤©æ•¸</th>
            <th class="col-stat-wide ${hideStats?'hide-col':''}">çœŸå¯¦æ ¼å­ç¸½æ•¸</th>
        </tr></thead><tbody>`;

    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month - 1, d);
        const dayIdx = date.getDay();
        const rowData = savedData[d] || {};

        html += `<tr data-day="${d}">
            <td class="${dayIdx===0?'sunday':(dayIdx===6?'saturday':'')}">${d}</td>
            <td class="${dayIdx===0?'sunday':(dayIdx===6?'saturday':'')}">${["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"][dayIdx]}</td>
            ${staffNames.map((name, i) => name ? `
                <td class="cell">
                    <div contenteditable="true" class="editable-content" onblur="handleInput(this, ${d})">${rowData['s'+i] || ''}</div>
                    <div class="quick-menu">
                        ${quickOptions.map(opt => `<button class="quick-btn" onclick="quickFill(this, '${opt}', ${d})">${opt}</button>`).join('')}
                        <button class="quick-btn" style="color:red; font-weight:bold" onclick="quickFill(this, '', ${d})">æ¸…é™¤</button>
                    </div>
                </td>` : '').join('')}
            <td contenteditable="true" class="note-cell" onblur="saveRowData(${d})">${rowData.note || ''}</td>
            <td class="stat-can-leave"></td>
            <td class="stat-predict ${hideStats?'hide-col':''}"></td>
            <td contenteditable="true" class="stat-deduct ${hideStats?'hide-col':''}" onblur="saveRowData(${d})">${rowData.deduct || 0}</td>
            <td class="stat-real ${hideStats?'hide-col':''}"></td>
        </tr>`;
    }
    table.innerHTML = html;
    document.querySelectorAll('.editable-content').forEach(updateCellStyle);
    calculateAll();
}

function handleGlobalPaste(e) {
    const activeEl = document.activeElement;
    if (!activeEl || !activeEl.classList.contains('editable-content')) return;
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text');
    const rows = text.split(/\r\n|\n|\r/);
    const startTd = activeEl.closest('td');
    const startRow = startTd.closest('tr');
    const startDay = parseInt(startRow.dataset.day);
    const startColIdx = Array.from(startRow.cells).indexOf(startTd);

    rows.forEach((rowText, rowIndex) => {
        if (!rowText && rowIndex > 0) return;
        const targetDay = startDay + rowIndex;
        const targetRow = document.querySelector(`tr[data-day="${targetDay}"]`);
        if (!targetRow) return;
        rowText.split('\t').forEach((colText, colIndex) => {
            const targetTd = targetRow.cells[startColIdx + colIndex];
            if (targetTd && targetTd.querySelector('.editable-content')) {
                const editDiv = targetTd.querySelector('.editable-content');
                editDiv.innerText = colText.trim();
            }
        });
        saveRowData(targetDay);
    });
}

function quickFill(btn, text, day) {
    const editable = btn.closest('td').querySelector('.editable-content');
    editable.innerText = text;
    saveRowData(day);
}

function handleInput(el, day) { 
    saveRowData(day); 
}

function updateCellStyle(el) {
    const cell = el.parentElement;
    const val = el.innerText.trim();
    cell.classList.remove("status-holiday", "status-exchange", "status-monthly", "status-official");
    if (val === "") return;
    if (val.startsWith("ä¼‘å‡")) cell.classList.add("status-holiday");
    else if (val.startsWith("æ›ä¼‘")) cell.classList.add("status-exchange");
    else if (val === "æœˆè£œ") cell.classList.add("status-monthly");
    else if (val === "å…¬å‡A1") cell.classList.add("status-official");
}

function calculateRow(row) {
    const cells = Array.from(row.querySelectorAll('.cell .editable-content'));
    let emptyCount = 0;
    // åªè¨ˆç®—å‰ 14 ä½äººå“¡ (A/Bç­)
    for (let i = 0; i < Math.min(cells.length, 14); i++) {
        if (cells[i].innerText.trim() === "") emptyCount++;
    }
    const deduct = parseInt(row.querySelector('.stat-deduct').innerText) || 0;
    const real = emptyCount - deduct;
    const pEl = row.querySelector('.stat-predict');
    const rEl = row.querySelector('.stat-real');
    if (pEl) pEl.innerText = emptyCount;
    if (rEl) {
        rEl.innerText = real;
        rEl.classList.toggle('warning-red', real < 5);
    }
    row.querySelector('.stat-can-leave').innerText = real >= 7 ? 2 : (real === 6 ? 1 : 0);
}

function calculateAll() { document.querySelectorAll('#dutyTable tbody tr').forEach(calculateRow); }

// ä¸Šå‚³å–®æ—¥è³‡æ–™åˆ°é›²ç«¯
function saveRowData(day) {
    const [year, month] = document.getElementById('monthPicker').value.split('-');
    const row = document.querySelector(`tr[data-day="${day}"]`);
    if(!row) return;

    showSaved("â— åŒæ­¥ä¸­...", "#ff9800");

    const rowObj = {
        note: row.querySelector('.note-cell').innerText,
        deduct: row.querySelector('.stat-deduct').innerText
    };
    row.querySelectorAll('.cell .editable-content').forEach((el, i) => rowObj['s' + i] = el.innerText);

    db.ref(`duty_system/${year}_${month}/content/${day}`).set(rowObj);
}

function clearData() { 
    if(confirm("ç¢ºå®šæ¸…ç©ºæœ¬æœˆé›²ç«¯è³‡æ–™ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼")) { 
        const [year, month] = document.getElementById('monthPicker').value.split('-');
        db.ref(`duty_system/${year}_${month}`).remove();
    } 
}

// å•Ÿå‹•ç³»çµ±
initTable();
</script>
</body>
</html>